<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="moment.js"></script>
    <style> 
      .user {
        color: blue;
      }
      .tweet {
      }
      }
    </style>
  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $body = $('body'),
        archive = [],
        show = true,
        targetUser = '';
        $body.html('');

        (function displayTweet () {
          let tempStream = streams.home.reverse();
          streams.home = [];
          
          (function recursiveDisplay () {
            function appendShow (tweet) {
              $tweet.appendTo($body).show('fast', () => {
                archive.push(tweet);
                scrollToBottom();
                recursiveDisplay();
              })
            }
            function appendHide (tweet) {
              $tweet.appendTo($body).hide(() => {
                archive.push(tweet);
                recursiveDisplay();
              })
            }
            if(tempStream.length > 0) {
              let tweet = tempStream.pop();
              $tweet = $('<div class=\'tweet\' id=\'' + tweet.user + '\' data=\'#' + tweet.user +'\'>' + '<span class=\'user\'>' + '@' + tweet.user + '</span> (<span class=\'time\' data=\'' + tweet.created_at.unformatted + '\'>just now</span>): ' + tweet.message + ' [' + tweet.created_at.formatted + ']' + '</div>').hide();
              if(show) {
                appendShow(tweet)
              } else if(targetUser) {
                if(tweet.user === targetUser.slice(1, targetUser.length)) {
                  appendShow(tweet)
                } else {
                  appendHide(tweet)
                }
              } else {
                appendHide(tweet)
              }
            } else {
              setTimeout(displayTweet, 400)}
          }).call(this);
        }).call(this);



        $('body').on('click', '.user', function () {
          if(show) {
            show = false,
            targetUser = $(this).closest('.tweet').attr('data');
            $('.tweet').filter('.tweet:not(' + targetUser + ')').hide()
          } else {
            show = true;
            $('.tweet').filter('.tweet:not(' + targetUser + ')').show()
            targetUser = '';
            scrollToBottom();
          }

        })

        setInterval(function() {
         // var tempScrollTop = $(window).scrollTop();
          var timeIndex = $('body').find('.time');
          for(var item in timeIndex) {
            timeIndex[item].textContent = moment(new Date(timeIndex.attr('data'))).fromNow();
          }
          scrollToBottom();
        }, 10000);

      });
      function scrollToBottom() {
        $('html, body').animate({scrollTop: $(document).height()}, 'slow')
      }
    </script>
  </body>
</html>
